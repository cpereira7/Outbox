name: Bruno API Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  api-tests:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    env:
      POSTGRES_DB: outbox_db
      POSTGRES_USER: outbox_user
      POSTGRES_PASSWORD: outbox_pass
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8080
      API_PORT: 5000

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build services
      run: docker compose build

    - name: Start PostgreSQL
      run: docker compose up -d postgres

    - name: Run migrations
      run: docker compose run --rm migrations

    - name: Start API
      run: docker compose up -d api

    - name: Wait for API to be ready
      run: |
        echo "Waiting for API to be ready..."
        timeout 60 bash -c 'until curl -f http://localhost:5000/swagger/index.html > /dev/null 2>&1; do sleep 2; done'
        echo "API is ready!"

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install Bruno CLI
      run: npm install -g @usebruno/cli

    - name: Run Bruno tests
      run: |
        bru run . --env-var baseUrl=http://localhost:5000 -r --reporter-junit results.xml
      working-directory: Bruno/Outbox

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: bruno-test-results
        path: Bruno/Outbox/results.xml

    - name: Show API logs on failure
      if: failure()
      run: docker compose logs api

    - name: Stop services
      if: always()
      run: docker compose down -v
